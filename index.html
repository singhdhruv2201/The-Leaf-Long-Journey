<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Leaf-Long Journey — Prototype</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="assets/tailwind.css" />
  </head>
  <body>
    <!-- UI controls removed (start/reset/speed) — use the start menu instead -->

    <!-- Game canvas; menu is a separate page (menu.html) -->
    <div id="gameActions"></div>

    <!-- HUD removed: using 3D-attached health label above the head -->
    <canvas id="glcanvas"></canvas>

    <!-- Debug movement controls removed for production -->

    <!-- Import map for Three.js ESM -->
    <script>
      // Keep URL params available to other scripts; do not auto-redirect so the greeting can run.
      let __hasEnv = false;
      try { __hasEnv = new URLSearchParams(window.location.search).has('env'); } catch (e) { __hasEnv = false; }
    </script>
    <nav class="fixed left-4 top-4 z-50">
      <a href="menu.html" class="text-white bg-slate-800/60 px-3 py-2 rounded-md hover:bg-slate-800 transition">Menu</a>
    </nav>

    <!-- Animated intro: big logo that morphs into the start panel -->
    <div id="greeting" class="fixed inset-0 flex items-center justify-center bg-gradient-to-b from-slate-900/70 to-transparent z-40">
      <div id="logoStage" class="flex flex-col items-center gap-6 pointer-events-none">
        <img id="gameLogo" src="assets/Gemini_Generated_logo_fall_background.png" alt="logo" class="w-[600px] max-w-[90vw] will-change-transform" />
        <div id="startPanel" class="mt-4 flex gap-3 opacity-0 scale-95 pointer-events-none">
          <button id="startBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-md">Start</button>
          <button id="creditsBtn" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-md">Credits</button>
        </div>
      </div>
    </div>
    <script type="importmap">
    {
      "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.module.js" }
    }
    </script>
    <script type="module" src="main.js"></script>
    <script>
      // Helper: ensure Motion One is loaded (same as menu helper)
      function ensureMotionOne(timeout = 5000) {
        // Try a local vendor file first (assets/motion.min.js), then fall back to CDN
        return new Promise((resolve, reject) => {
          try { if (typeof window !== 'undefined' && window.motion) return resolve(window.motion); } catch (e) {}

          const tryLoad = (src) => new Promise((res, rej) => {
            const s = document.createElement('script');
            let done = false;
            const t = setTimeout(() => { if (done) return; done = true; rej(new Error('load timeout')); }, timeout);
            s.src = src; s.async = true;
            s.onload = () => { if (done) return; done = true; clearTimeout(t); res(window.motion || true); };
            s.onerror = (err) => { if (done) return; done = true; clearTimeout(t); rej(err); };
            document.head.appendChild(s);
          });

          (async () => {
            try {
              // try local
              await tryLoad('assets/motion.min.js');
              return resolve(window.motion || null);
            } catch (e) {
              // local failed — try CDN
              try {
                await tryLoad('https://unpkg.com/motion@10.17.7/dist/motion.min.js');
                return resolve(window.motion || null);
              } catch (err) {
                return reject(err);
              }
            }
          })();
        });
      }

      (async function(){
        try {
          const motionLib = await ensureMotionOne().catch((e) => { console.warn('Failed to load Motion One, skipping intro', e); return null; });
          // if an env is present, skip the greeting (go straight to game)
          if (typeof __hasEnv !== 'undefined' && __hasEnv) {
            document.getElementById('greeting').style.display = 'none';
            return;
          }
          if (!motionLib) return;
          const logo = document.getElementById('gameLogo');
          const panel = document.getElementById('startPanel');
          // initial fade+pop for the logo
          await motionLib.animate(logo, { opacity: [0,1], scale: [0.85, 1.08, 1] }, { duration: 0.9, easing: 'spring(500,30,10)' });
          await new Promise(r => setTimeout(r, 420));
          await motionLib.animate(logo, { translateY: [0, -180], scale: [1, 0.24] }, { duration: 0.85, easing: 'ease-in-out' });
          motionLib.animate(logo, { opacity: [1, 0.98] }, { duration: 0.5 });
          motionLib.animate(panel, { opacity: [0,1], y: [12,0], scale: [0.98,1] }, { duration: 0.5, easing: 'ease' });
          panel.style.pointerEvents = 'auto';
          document.getElementById('startBtn').addEventListener('click', () => { window.location.href = 'menu.html'; });
          document.getElementById('creditsBtn').addEventListener('click', () => { alert('Credits:\nPrototype by you. Assets: user-provided GLBs.'); });
        } catch (err) { console.warn('Logo intro failed', err); }
      })();
    </script>
  </body>
</html>
